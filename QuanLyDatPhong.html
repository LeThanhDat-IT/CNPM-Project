<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản Lý Đặt Phòng - THE COW HOTEL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; background: #f5f5f5; margin: 0; }
    .topbar {
      background-color: #fff; display: flex; align-items: center; justify-content: space-between;
      padding: 10px 40px; border-bottom: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid #ffd700;
    }
    .topbar .logo { font-size: 22px; font-weight: 700; color: #333; }
    .topbar nav ul { list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; }
    .topbar nav ul li a { text-decoration: none; color: #333; font-weight: 600; transition: color 0.3s; }
    .topbar nav ul li a:hover { color: #e4a11b; }
    .section {
      max-width: 1100px;
      margin: 40px auto;
      padding: 30px 16px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      border: 1px solid #ffd700;
      overflow-x: auto;
    }
    .header { display: flex; align-items: center; gap: 18px; margin-bottom: 28px; }
    .header img { height: 52px; border-radius: 10px; cursor: pointer; box-shadow: 0 2px 8px #0002; }
    .header h1 { color: #1a2d6c; font-size: 2em; margin: 0; font-weight: 700; }
    .form-row { display: flex; gap: 18px; margin-bottom: 18px; flex-wrap: wrap; }
    .form-group { flex: 1 1 180px; min-width: 160px; display: flex; flex-direction: column; margin-bottom: 8px; }
    label { font-weight: 600; margin-bottom: 6px; color: #223b79; }
    input, select {
      padding: 10px 12px; border: 1.5px solid #cfd8e3; border-radius: 8px; font-size: 1em;
      background: #f8fafc; transition: border 0.2s;
    }
    input:focus, select:focus { border: 2px solid #e4a11b; outline: none; background: #fffbe6; }
    .form-actions { display: flex; gap: 14px; margin-bottom: 10px; justify-content: center; flex-wrap: wrap; }
    .form-actions button {
      background-color: #e4a11b; color: white; border: none; padding: 10px 20px; font-weight: bold;
      border-radius: 5px; cursor: pointer; transition: background 0.3s; font-size: 1em; display: flex; align-items: center; gap: 8px;
    }
    .form-actions button:hover { background-color: #c98f0b; }
    table {
      width: 100%;
      min-width: 900px;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 18px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(34,59,121,0.08);
      border: 1.5px solid #e4a11b;
    }
    th, td {
      padding: 12px 10px; text-align: center; font-size: 1.05em; border-bottom: 1px solid #e4a11b; white-space: nowrap;
    }
    th { background: #e4a11b; color: #fff; font-weight: 700; }
    tr:last-child td { border-bottom: none; }
    tr:nth-child(even) { background: #f8fafc; }
    tr:hover { background: #fffbe6; cursor: pointer; }
    #user-action { display: flex; align-items: center; gap: 12px; }
    #user-action > span { font-weight: 600; margin-right: 18px; display: flex; align-items: center; color: #222; font-size: 16px; }
    #user-action > span i { margin-right: 7px; font-size: 18px; }
    #user-action ul { display: flex; gap: 0; list-style: none; margin: 0; padding: 0; }
    #user-action ul li { display: flex; align-items: center; justify-content: center; }
    #user-action ul li a.admin-link {
      text-decoration: none; color: #333; font-weight: 600; background: none; border: none; padding: 0 10px;
      border-radius: 0; font-size: 16px; transition: color 0.25s, background 0.25s; display: inline-block; outline: none;
      height: 40px; line-height: 40px; min-width: 80px; text-align: center;
    }
    #user-action ul li a.admin-link:hover, #user-action ul li a.admin-link:focus {
      color: #e4a11b; background: #f7f1e1; text-decoration: none;
    }
    #user-action ul li a.admin-link[style*="color:#888"] { color: #888 !important; }
    #user-action ul li:last-child a.admin-link { color: #888; }
    @media (max-width: 1200px) {
      .section { max-width: 100vw; padding: 18px 2vw; }
      table { min-width: 700px; font-size: 0.95em; }
      .form-row { flex-wrap: wrap; }
      .form-group { min-width: 120px; }
    }
    @media (max-width: 900px) {
      .section { padding: 8px 0; }
      .form-row { flex-direction: column; gap: 8px; }
      .form-group { width: 100%; min-width: 0; }
      table { min-width: 600px; }
    }
    @media (max-width: 600px) {
      .section { padding: 4px 0; }
      .header h1 { font-size: 1.2em; }
      table { font-size: 0.85em; min-width: 400px; }
      th, td { padding: 8px 4px; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">THE COW HOTEL</div>
    <nav>
      <ul>
        <li><a href="HomePage.html">Home</a></li>
        <li><a href="#about">About Us</a></li>
        <li><a href="#rooms">Rooms</a></li>
        <li><a href="#contact">Contact</a></li>
      </ul>
    </nav>
    <div id="user-action"></div>
  </div>
  <div class="section">
    <div class="header">
      <img src="images/a3.jpg" alt="Logo" onclick="window.location.href='HomePage.html'">
      <h1><i class="fa-solid fa-calendar-check"></i> Quản Lý Đặt Phòng</h1>
    </div>
    <form id="booking-form" autocomplete="off">
      <div class="form-row">
        <div class="form-group">
          <label for="bookingCode">Mã đặt phòng</label>
          <input type="text" id="bookingCode" placeholder="Nhập mã đặt phòng">
        </div>
        <div class="form-group">
          <label for="fullname">Tên khách</label>
          <input type="text" id="fullname" placeholder="Tên khách hàng">
        </div>
        <div class="form-group">
          <label for="phone">SĐT</label>
          <input type="text" id="phone" placeholder="Số điện thoại">
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="text" id="email" placeholder="Email">
        </div>
        <div class="form-group">
          <label for="room">Mã phòng</label>
          <input type="text" id="room" placeholder="Mã phòng">
        </div>
      </div>
      <div class="form-actions">
        <button type="button" id="btn-search"><i class="fa-solid fa-magnifying-glass"></i> Tìm kiếm</button>
        <button type="button" id="btn-showall"><i class="fa-solid fa-list"></i> Hiển thị tất cả</button>
        <button type="button" id="btn-delete"><i class="fa-solid fa-trash"></i> Xóa</button>
      </div>
    </form>
    <table id="booking-table">
      <thead>
        <tr>
          <th>Mã đặt phòng</th>
          <th>Tên khách</th>
          <th>SĐT</th>
          <th>Email</th>
          <th>Mã phòng</th>
          <th>Tên phòng</th>
          <th>Nhận phòng</th>
          <th>Trả phòng</th>
          <th>Trạng thái phòng</th>
          <th>Thanh toán</th>
          <th>Tổng tiền</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    let bookings = [];

    async function fetchBookingList() {
      const res = await fetch('PHP/get_bookings.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: '' }) // Lấy tất cả booking
      });
      const data = await res.json();
      bookings = data.bookings || [];
      renderBookingList(bookings);
    }

    function renderBookingList(list) {
      const tbody = document.querySelector('#booking-table tbody');
      tbody.innerHTML = '';
      list.forEach(bk => {
        const status = bk.TrangThaiPhong == 1 ? 'Đã nhận' : (bk.TrangThaiPhong == 2 ? 'Đã trả' : 'Chưa nhận');
        const paid = bk.TrangThaiThanhToan == 1 ? '<span style="color:green;font-weight:bold;">Đã TT</span>' : '<span style="color:#d10000;font-weight:bold;">Chưa TT</span>';
        tbody.innerHTML += `
          <tr onclick="fillForm('${bk.bookingCode}')">
            <td>${bk.bookingCode}</td>
            <td>${bk.fullname}</td>
            <td>${bk.phone}</td>
            <td>${bk.email}</td>
            <td>${bk.room}</td>
            <td>${bk.roomName || ''}</td>
            <td>${bk.checkin}</td>
            <td>${bk.checkout}</td>
            <td>${status}</td>
            <td>${paid}</td>
            <td>${Number(bk.total || 0).toLocaleString()} đ</td>
          </tr>
        `;
      });
    }

    window.fillForm = function(bookingCode) {
      const bk = bookings.find(b => b.bookingCode === bookingCode);
      if (!bk) return;
      document.getElementById('bookingCode').value = bk.bookingCode;
      document.getElementById('fullname').value = bk.fullname;
      document.getElementById('phone').value = bk.phone;
      document.getElementById('email').value = bk.email;
      document.getElementById('room').value = bk.room;
    };

    async function searchBooking() {
      const code = document.getElementById('bookingCode').value.trim();
      const fullname = document.getElementById('fullname').value.trim().toLowerCase();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const room = document.getElementById('room').value.trim();

      let result = bookings;
      if (code) result = result.filter(b => b.bookingCode && b.bookingCode.includes(code));
      if (fullname) result = result.filter(b => b.fullname && b.fullname.toLowerCase().includes(fullname));
      if (phone) result = result.filter(b => b.phone && b.phone.includes(phone));
      if (email) result = result.filter(b => b.email && b.email.toLowerCase().includes(email));
      if (room) result = result.filter(b => b.room && b.room.includes(room));
      renderBookingList(result);
    }

    async function deleteBooking() {
      const code = document.getElementById('bookingCode').value.trim();
      if (!code) return alert('Chọn mã đặt phòng để xóa!');
      if (!confirm('Bạn chắc chắn muốn xóa booking này?')) return;
      const res = await fetch('PHP/delete_booking.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ bookingCode: code })
      });
      const result = await res.json();
      alert(result.success ? 'Xóa booking thành công!' : (result.message || 'Xóa booking thất bại!'));
      fetchBookingList();
    }

    document.getElementById('btn-search').onclick = searchBooking;
    document.getElementById('btn-showall').onclick = fetchBookingList;
    document.getElementById('btn-delete').onclick = deleteBooking;

    document.addEventListener('DOMContentLoaded', fetchBookingList);

    // Copy phần renderUserAction và logout từ các trang khác
    function renderUserAction() {
      const userAction = document.getElementById('user-action');
      const username = localStorage.getItem('username');
      const role = localStorage.getItem('role');
      if (username) {
        let adminLinks = '';
        if (role === 'admin') {
          adminLinks = `
            <li><a href="QuanLyKhachHang.html" class="admin-link">Quản lý KH</a></li>
            <li><a href="QuanLyPhong.html" class="admin-link">Quản lý Phòng</a></li>
            <li><a href="QuanLyDatPhong.html" class="admin-link">Quản lý ĐP</a></li>
            <li><a href="quanly_tk.html" class="admin-link">Quản lý TK</a></li>
            <li><a href="ThongKeThuNhap.html" class="admin-link">Thống kê</a></li>
          `;
        }
        userAction.innerHTML = `
          <span style="font-weight:600;margin-right:16px;display:flex;align-items:center;"><i class="fa fa-user"></i> ${username}</span>
          <ul style="display:inline-flex;gap:20px;list-style:none;margin:0;padding:0;vertical-align:middle;">
            ${adminLinks}
           
            <li><a href="#" class="admin-link" onclick="logout();return false;" style="color:#888;">Logout</a></li>
          </ul>
        `;
      } else {
        userAction.innerHTML = `
          <ul style="display:inline-flex;gap:20px;list-style:none;margin:0;padding:0;vertical-align:middle;">
            <li><a href="dangnhap.html" class="admin-link"><i class="fa fa-user"></i> Login</a></li>
            <li><a href="TIm_kiemphong.html" class="admin-link">Book Now</a></li>
          </ul>
        `;
      }
    }
    function logout() {
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      localStorage.removeItem('user_email');
      renderUserAction();
    }
    renderUserAction();
  </script>
</body>
</html>